name: Main CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 2 * * 1'  # Tous les lundis Ã  2h du matin
  workflow_dispatch:  # Permet le dÃ©clenchement manuel

permissions:
  security-events: write
  contents: read
  actions: read


jobs:
  build-and-test:
    uses: ./.github/workflows/build-unit-tests.yml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 2 : ANALYSE DE SÃ‰CURITÃ‰ STATIQUE (SAST)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-quality-sast:
    needs: build-and-test
    uses: ./.github/workflows/code-quality-sast.yml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 3 : DÃ‰TECTION DE SECRETS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secret-scanning:
    needs: build-and-test  # âš ï¸ S'exÃ©cute en PARALLÃˆLE avec code-quality-sast
    uses: ./.github/workflows/secret-scanning.yml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 4 : ANALYSE DES DÃ‰PENDANCES (SCA)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sca-dependency-scan:
    needs: build-and-test  # Ã‰galement en parallÃ¨le
    uses: ./.github/workflows/sca-dependency-scan.yml
    secrets: inherit  # âš ï¸ IMPORTANT pour passer NVD_API_KEY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 5 : SÃ‰CURITÃ‰ INFRASTRUCTURE AS CODE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secure-iac-dockerfile-scan:
    needs: build-and-test  # Toujours en parallÃ¨le
    uses: ./.github/workflows/secure-iac-dockerfile-scan.yml
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 6 : BUILD & SCAN DOCKER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-scan-docker:
    needs: [ code-quality-sast, secret-scanning, secure-iac-dockerfile-scan, sca-dependency-scan]
    uses: ./.github/workflows/build-docker-image.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 7: PUBLICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish-docker-hub:
    needs: [ build-and-scan-docker ]
    uses: ./.github/workflows/publish-docker-hub.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 8: DAST (AprÃ¨s publication Docker Hub)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dast-dynamic-security-testing:
    needs: publish-docker-hub
    uses: ./.github/workflows/dast-zap-test.yml
    secrets: inherit
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ã‰TAPE 9 : DÃ‰PLOIEMENT EN PRODUCTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy-docker:
    needs: dast-dynamic-security-testing
    uses: ./.github/workflows/deploy-production-server.yml
    secrets: inherit


  send-notifications:
    name: Send Notifications
    needs:
      - build-and-test
      - code-quality-sast
      - secret-scanning
      - sca-dependency-scan
      - secure-iac-dockerfile-scan
      - build-and-scan-docker
      - deploy-docker
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š Check pipeline status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š PIPELINE STATUS REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Build & Test: ${{ needs.build-and-test.result }}"
          echo "SAST: ${{ needs.code-quality-sast.result }}"
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "SCA: ${{ needs.sca-dependency-scan.result }}"
          echo "IaC Security: ${{ needs.secure-iac-dockerfile-scan.result }}"
          echo "Docker Build: ${{ needs.build-and-scan-docker.result }}"
          echo "Deployment: ${{ needs.deploy-docker.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"